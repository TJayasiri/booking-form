<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenleaf Admin â€¢ Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--brand:#62BBC1}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#f7f7f8;color:#0b0b0c}
    header{position:sticky;top:0;background:#ffffffcc;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input,select,button{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
    input:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 2px #62bbc133}
    button{background:var(--brand);color:#032b2f;border:none;cursor:pointer}
    button.secondary{background:#fff;border:1px solid #cbd5e1}
    a.card{display:block;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;text-decoration:none;color:inherit}
    a.card:hover{border-color:#cbd5e1;background:#fafafa}
    .muted{color:#6b7280;font-size:12px}
    .note{padding:8px 10px;border:1px dashed #cbd5e1;border-radius:8px;background:#fff}
    .ok{color:#047857}.bad{color:#b91c1c}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px;vertical-align:top}
    th{background:#f7f7f7;text-align:left}
    @media (max-width:640px){
      .row{flex-direction:column;align-items:stretch}
      input,select,button{font-size:14px}
      table{font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 style="margin:0;font-size:18px">Greenleaf Admin</h1>
      <span class="muted">Internal tools â€¢ do not share</span>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:16px">
    <!-- Quick links -->
    <div class="row" style="gap:12px">
      <a class="card" href="./tracker.html">ðŸ“Š Tracker â€” view job + history</a>
      <a class="card" href="./locks.html">ðŸ”’ Locks â€” lock/unlock a booking</a>
    </div>

    <!-- Admin key -->
    <section class="grid">
      <h2 style="margin:6px 0 0">Admin key</h2>
      <div class="row">
        <input id="adminKey" type="password" placeholder="Paste ADMIN_KEYâ€¦" size="36" />
        <button id="saveKey">Save key</button>
        <button class="secondary" id="showKey">Show</button>
        <span id="keyState" class="muted"></span>
      </div>
      <div class="note">Your key is stored only in <strong>this browserâ€™s</strong> localStorage as <code>ADMIN_KEY</code>.</div>
    </section>

    <!-- Stage updater -->
    <section class="grid">
      <h2 style="margin:6px 0 0">Update workflow stage</h2>
      <div class="row" style="margin-top:6px">
        <input id="refForStage" type="text" placeholder="GLB-â€¦" size="20" />
        <select id="stageSel">
          <option value="APPLICATION_SUBMITTED">Application submitted</option>
          <option value="ACCEPTED_INITIATED">Accepted &amp; initiated (locked)</option>
          <option value="ESTIMATE_INVOICE_ISSUED">Estimate/Invoice issued</option>
          <option value="AGREEMENT_GENERATED">Agreement generated</option>
          <option value="SCHEDULE_RELEASED">Schedule released</option>
          <option value="REPORT_ACTION_TAKEN">Report / Action taken</option>
          <option value="FOLLOW_UP">Follow-up</option>
          <option value="COMPLETED">Completed</option>
        </select>
        <input id="dueAt" type="datetime-local" />
        <button id="btnStage">Update Stage</button>
      </div>
      <div id="stageMsg" class="muted"></div>
    </section>

    <!-- Booking Index -->
    <section class="grid">
      <h2 style="margin:6px 0 0">Booking Index</h2>
      <div class="row" style="margin-top:6px">
        <button id="btnReload">Reload list</button>
        <button id="btnMore" class="secondary" disabled>Load more</button>
        <span id="msg" class="muted"></span>
      </div>
      <table id="tbl">
        <thead>
          <tr>
            <th>refId</th>
            <th>ts</th>
            <th>name</th>
            <th>email</th>
            <th>locked</th>
            <th>version</th>
            <th>views</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    /* ---------- helpers ---------- */
    const $ = (id) => document.getElementById(id);
    const tbody = document.querySelector('#tbl tbody');

    function setBanner(elId, text, ok=true){
      const el = $(elId);
      el.textContent = text;
      el.className = ok ? 'ok' : 'bad';
    }
    function refreshKeyState(){
      const has = !!localStorage.getItem('ADMIN_KEY');
      const el = $('keyState');
      el.textContent = has ? 'Key saved âœ“' : 'No key saved';
      el.className = has ? 'ok' : 'bad';
    }
    function cell(text){ const td=document.createElement('td'); td.textContent=text??''; return td; }
    function button(label, onClick){ const b=document.createElement('button'); b.textContent=label; b.onclick=onClick; return b; }

    /* ---------- key UI ---------- */
    $('saveKey').onclick = ()=>{
      const v = $('adminKey').value.trim();
      if(!v){ alert('Paste a key first'); return; }
      localStorage.setItem('ADMIN_KEY', v);
      $('adminKey').value = '';
      refreshKeyState();
      loadIndex(true);
    };
    $('showKey').onclick = ()=>{
      const v = localStorage.getItem('ADMIN_KEY') || '';
      if(!v){ alert('No key saved'); return; }
      prompt('Your current ADMIN_KEY (copy if needed):', v);
    };
    refreshKeyState();

    /* ---------- stage update ---------- */
    $('btnStage').onclick = async () => {
      const ref   = $('refForStage').value.trim();
      const stage = $('stageSel').value;
      const dueAtRaw = $('dueAt').value || null; // "YYYY-MM-DDTHH:mm"
      const key   = localStorage.getItem('ADMIN_KEY') || '';
      if(!ref){ alert('Enter a reference'); return; }
      if(!key){ alert('Admin key missing'); return; }

      const dueAt = dueAtRaw ? new Date(dueAtRaw).toISOString() : null;

      try{
        const res = await fetch('/.netlify/functions/job-update', {
          method: 'POST',
          headers: {'Content-Type':'application/json','X-Admin-Key':key},
          body: JSON.stringify({ ref, stage, dueAt })
        });
        const txt = await res.text().catch(()=> '');
        const ok = res.ok;
        setBanner('stageMsg', ok ? `Stage updated âœ“ (${ref})` : `Error: ${txt || res.status}`, ok);
        if(ok) loadIndex(true);
      }catch(e){
        setBanner('stageMsg', 'Request failed: ' + e.message, false);
      }
    };

    /* ---------- booking index w/ pagination ---------- */
    let cursor = ''; // server may return nextCursor
    function appendRows(rows){
      for(const r of rows){
        const tr = document.createElement('tr');

        // refId cell clickable -> fills the stage box
        const tdRef = document.createElement('td');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = r.id;
        a.onclick = (e)=>{ e.preventDefault(); $('refForStage').value = r.id; window.scrollTo({top:0,behavior:'smooth'}); };
        tdRef.appendChild(a);
        tr.appendChild(tdRef);

        tr.appendChild(cell(r.ts));
        tr.appendChild(cell(r.name));
        tr.appendChild(cell(r.email));
        tr.appendChild(cell(r.locked ? 'TRUE':'FALSE'));
        tr.appendChild(cell(String(r.version ?? '')));
        tr.appendChild(cell(String(r.views ?? '')));

        const tdAct = document.createElement('td');
        const bLock = button('Lock', ()=>doAction('lock', r.id));
        const bUnlock = button('Unlock', ()=>doAction('unlock', r.id));
        bUnlock.style.marginLeft = '6px';
        tdAct.appendChild(bLock);
        tdAct.appendChild(bUnlock);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      }
    }

    async function loadIndex(reset=false){
      if (reset) {
        cursor = '';
        tbody.innerHTML = '';
      }
      const key = localStorage.getItem('ADMIN_KEY') || '';
      if(!key){ setBanner('msg','Enter admin key first.', false); return; }
      try{
        const url = new URL('/.netlify/functions/booking-index', location.origin);
        url.searchParams.set('limit', '100');
        if (cursor) url.searchParams.set('cursor', cursor);

        const res = await fetch(url, { headers:{'X-Admin-Key':key} });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          setBanner('msg', 'Unauthorized or error loading index. ' + txt, false);
          return;
        }

        const data = await res.json();

        // Support both shapes:
        // 1) Old: data is an array of rows
        // 2) New: data = { rows, nextCursor }
        const rows = Array.isArray(data) ? data : (data.rows || []);
        const nextCursor = Array.isArray(data) ? '' : (data.nextCursor || '');

        appendRows(rows);

        cursor = nextCursor;
        $('btnMore').disabled = !cursor;

        const currentCount = document.querySelectorAll('#tbl tbody tr').length;
        setBanner('msg', `Loaded ${currentCount} record(s).`, true);
      }catch(e){
        setBanner('msg','Failed to load index: ' + e.message, false);
      }
    }

    $('btnReload').onclick = ()=> loadIndex(true);
    $('btnMore').onclick   = ()=> loadIndex(false);

    /* ---------- lock / unlock ---------- */
    async function doAction(action, refId){
      const key = localStorage.getItem('ADMIN_KEY') || '';
      if(!key){ setBanner('msg','Enter admin key first.', false); return; }
      try{
        const res = await fetch('/.netlify/functions/booking-admin', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-Admin-Key':key},
          body:JSON.stringify({ refId, action })
        });
        const txt = await res.text().catch(()=> '');
        const ok = res.ok;
        setBanner('msg', ok ? `${action.toUpperCase()} OK for ${refId}` : `Error: ${txt || res.status}`, ok);
        if(ok) loadIndex(true);
      }catch(e){
        setBanner('msg','Request failed: ' + e.message, false);
      }
    }

    /* ---------- auto-load ---------- */
    if(localStorage.getItem('ADMIN_KEY')) loadIndex(true);
  </script>
</body>
</html>
