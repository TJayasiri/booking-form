<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenleaf Admin â€¢ Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--brand:#62BBC1}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#f7f7f8;color:#0b0b0c}
    header{position:sticky;top:0;background:#fffdd;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:960px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input,select,button{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    input:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px #62bbc133}
    button{background:var(--brand);color:#032b2f;border:none;cursor:pointer}
    button.secondary{background:#fff;border:1px solid #cbd5e1}
    a.card{display:block;padding:14px 16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;text-decoration:none;color:inherit}
    a.card:hover{border-color:#cbd5e1;background:#fafafa}
    .muted{color:#6b7280;font-size:12px}
    .note{padding:10px 12px;border:1px dashed #cbd5e1;border-radius:10px;background:#fff}
    .ok{color:#047857}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 style="margin:0;font-size:18px">Greenleaf Admin</h1>
      <span class="muted">Internal tools â€¢ do not share</span>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:16px">
    <!-- Quick links -->
    <div class="row" style="gap:12px">
      <a class="card" href="./tracker.html">ðŸ“Š Tracker â€” view job + history</a>
      <a class="card" href="./locks.html">ðŸ”’ Locks â€” lock/unlock a booking</a>
    </div>

    <!-- Admin key -->
    <section class="grid">
      <h2 style="margin:6px 0 0">Admin key</h2>
      <div class="row">
        <input id="adminKey" type="password" placeholder="Paste ADMIN_KEYâ€¦" size="36" />
        <button id="saveKey">Save key</button>
        <button class="secondary" id="showKey">Show</button>
        <span id="keyState" class="muted"></span>
      </div>
      <div class="note">Your key is stored only in <strong>this browserâ€™s</strong> localStorage as <code>ADMIN_KEY</code>.</div>
    </section>

    <!-- Stage updater -->
    <section class="grid">
      <h2 style="margin:6px 0 0">Update workflow stage</h2>
      <div class="row" style="margin-top:6px">
        <input id="refForStage" type="text" placeholder="GLB-â€¦" size="24" />
        <select id="stageSel">
          <option value="APPLICATION_SUBMITTED">Application submitted</option>
          <option value="ACCEPTED_INITIATED">Accepted &amp; initiated (locked)</option>
          <option value="ESTIMATE_INVOICE_ISSUED">Estimate/Invoice issued</option>
          <option value="AGREEMENT_GENERATED">Agreement generated</option>
          <option value="SCHEDULE_RELEASED">Schedule released</option>
          <option value="REPORT_ACTION_TAKEN">Report / Action taken</option>
          <option value="FOLLOW_UP">Follow-up</option>
          <option value="COMPLETED">Completed</option>
        </select>
        <input id="dueAt" type="datetime-local" />
        <button id="btnStage">Update Stage</button>
      </div>
      <div id="stageMsg" class="muted"></div>
    </section>
  </main>

  <script>
    // --- Key UI
    const $ = (id)=>document.getElementById(id);
    const keyEl = $('adminKey');
    const keyState = $('keyState');
    function refreshKeyState(){
      const has = !!localStorage.getItem('ADMIN_KEY');
      keyState.textContent = has ? 'Key saved âœ“' : 'No key saved';
      keyState.className = has ? 'ok' : 'bad';
    }
    $('saveKey').onclick = ()=>{
      const v = keyEl.value.trim();
      if(!v){ alert('Paste a key first'); return; }
      localStorage.setItem('ADMIN_KEY', v);
      keyEl.value = '';
      refreshKeyState();
      alert('Key saved for this browser.');
    };
    $('showKey').onclick = ()=>{
      const v = localStorage.getItem('ADMIN_KEY') || '';
      if(!v){ alert('No key saved'); return; }
      prompt('Your current ADMIN_KEY (copy if needed):', v);
    };
    refreshKeyState();

    // --- Stage update
    $('btnStage').onclick = async () => {
      const ref   = $('refForStage').value.trim();
      const stage = $('stageSel').value;
      const dueAt = $('dueAt').value || null;
      const key   = localStorage.getItem('ADMIN_KEY') || '';
      if(!ref){ alert('Enter a reference'); return; }
      if(!key){ alert('Admin key missing'); return; }

      const res = await fetch('/api/job/update', {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-Admin-Key':key},
        body: JSON.stringify({ ref, stage, dueAt })
      });
      const txt = await res.text().catch(()=> '');
      $('stageMsg').textContent = res.ok ? 'Stage updated âœ“' : `Error: ${txt}`;
      $('stageMsg').className = res.ok ? 'ok' : 'bad';
      alert(res.ok ? 'Stage updated' : `Error: ${txt || res.status}`);
    };
  </script>
</body>
</html>