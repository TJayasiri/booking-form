<!-- TRACKING RIBBON + CONTROLS -->
<style>
  .glb-track-bar {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: #0b0b0c;
    color: #fff;
    border-bottom: 3px solid #62BBC1;
    padding: 10px 12px;
    font: 13px/1.3 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .glb-track-steps {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .glb-step {
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #334155;
    background: #0f1115;
    color: #e2e8f0;
    border-radius: 999px;
    padding: 4px 10px;
    font-weight: 600;
  }
  .glb-step.done {
    background: #08373c;
    border-color: #62BBC1;
    color: #d1faf5;
  }
  .glb-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #475569;
  }
  .glb-step.done .glb-dot {
    background: #62BBC1;
  }
  .glb-badge {
    margin-left: auto;
    font-weight: 700;
  }
  .glb-admin-box {
    margin: 12px 0;
    padding: 12px;
    border: 1px solid #e2e8e6;
    border-radius: 10px;
    background: #fff;
    font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .glb-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .glb-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .glb-admin-box input[type="datetime-local"],
  .glb-admin-box select,
  .glb-admin-box input[type="text"] {
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
  }
  .glb-admin-box button {
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: #fff;
    cursor: pointer;
  }
  .glb-admin-box button.brand {
    background: #62BBC1;
    color: #001014;
    border: none;
    font-weight: 700;
  }
  .glb-small {
    color: #64748b;
    font-size: 12px;
  }
</style>

<!-- Ribbon Display -->
<div id="trackingRibbon" class="glb-track-bar" hidden>
  <div class="glb-track-steps" id="trackSteps"></div>
  <div class="glb-badge" id="trackCountdown" role="status" aria-live="polite"></div>
</div>

<!-- Admin Controls -->
<div class="glb-admin-box">
  <form onsubmit="return false;">
    <div class="glb-row">
      <strong>Status tracker</strong>
      <span class="glb-small">• Demo persists to this browser. Wire to API later.</span>
    </div>

    <div class="glb-grid" style="margin-top:8px">
      <div class="glb-row">
        <label for="trkRef">Ref:</label>
        <input id="trkRef" type="text" placeholder="GLB-..." size="24" />
        <button type="button" id="trkLoad">Load</button>
        <button type="button" id="trkNew">New</button>
      </div>
      <div class="glb-row">
        <label for="trkTarget">Overall Target:</label>
        <input id="trkTarget" type="datetime-local" />
        <button type="button" id="trkSaveTarget">Save target</button>
      </div>
    </div>

    <div class="glb-row" style="margin-top:8px">
      <label for="trkStepSel">Step:</label>
      <select id="trkStepSel"></select>
      <label for="trkDoneAt">Done at:</label>
      <input id="trkDoneAt" type="datetime-local" />
      <label for="trkDueAt">Due at:</label>
      <input id="trkDueAt" type="datetime-local" />
      <button type="button" class="brand" id="trkMarkDone">Mark done</button>
      <button type="button" id="trkClear">Clear step</button>
    </div>

    <div class="glb-small" style="margin-top:6px">
      Default schedule offsets (from Submitted): Accepted +3h • Invoice +24h • Agreement +36h • Schedule +72h • Report +7d • Follow‑up +9d • Completed +10d.
    </div>
  </form>
</div>

<!-- Script Logic -->
<script>
(() => {
  const DEFAULT_STEPS = [
    { key: 'submitted', label: 'Application Submitted', offsetHours: 0 },
    { key: 'accepted', label: 'Greenleaf Accepted & Initiated (Locked)', offsetHours: 3 },
    { key: 'invoice', label: 'Estimate / Invoice Generated', offsetHours: 24 },
    { key: 'agreement', label: 'Agreement Generated', offsetHours: 36 },
    { key: 'schedule', label: 'Schedule Released to Team', offsetHours: 72 },
    { key: 'report', label: 'Report / Actions Taken', offsetHours: 24 * 7 },
    { key: 'followup', label: 'Follow-up Initiated (if applicable)', offsetHours: 24 * 9 },
    { key: 'done', label: 'Job Completed', offsetHours: 24 * 10 }
  ];

  const $ = s => document.querySelector(s);
  const ribbon = $('#trackingRibbon');
  const stepsWrap = $('#trackSteps');
  const countdownEl = $('#trackCountdown');

  const refInput = $('#trkRef');
  const loadBtn = $('#trkLoad');
  const newBtn = $('#trkNew');
  const targetInput = $('#trkTarget');
  const saveTargetBtn = $('#trkSaveTarget');
  const stepSel = $('#trkStepSel');
  const doneAtInput = $('#trkDoneAt');
  const dueAtInput = $('#trkDueAt');
  const markBtn = $('#trkMarkDone');
  const clearBtn = $('#trkClear');

  const LS_KEY = ref => `GLB_TRACK_${ref}`;
  function loadTracking(ref) {
    try {
      return JSON.parse(localStorage.getItem(LS_KEY(ref))) || null;
    } catch {
      return null;
    }
  }
  function saveTracking(trk) {
    localStorage.setItem(LS_KEY(trk.refId), JSON.stringify(trk));
    localStorage.setItem('GLB_LAST_REF', trk.refId);
  }

  const isoNow = () => new Date().toISOString();
  const addHours = (iso, h) => new Date(new Date(iso).getTime() + h * 3600 * 1000).toISOString();
  const toLocalDT = iso => iso ? new Date(iso).toISOString().slice(0, 16) : '';

  function buildInitial(ref) {
    const started = isoNow();
    const target = addHours(started, 24 * 10);
    return {
      refId: ref,
      startedAt: started,
      targetAt: target,
      steps: DEFAULT_STEPS.map(s => ({ ...s }))
    };
  }

  function renderRibbon(trk) {
    ribbon.hidden = !trk;
    stepsWrap.innerHTML = '';
    if (!trk) return;
    trk.steps.forEach(s => {
      const el = document.createElement('div');
      el.className = 'glb-step' + (s.doneAt ? ' done' : '');
      el.innerHTML = `<span class="glb-dot"></span>${s.label}` +
        (s.doneAt ? ` <span class="glb-small">(✓ ${new Date(s.doneAt).toLocaleString()})</span>` :
         s.dueAt ? ` <span class="glb-small">(due ${new Date(s.dueAt).toLocaleString()})</span>` : '');
      stepsWrap.appendChild(el);
    });
  }

  let countdownTimer = null;
  function startCountdown(trk) {
    clearInterval(countdownTimer);
    function tick() {
      const remainMs = new Date(trk.targetAt).getTime() - Date.now();
      if (remainMs