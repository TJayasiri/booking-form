<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenleaf Admin • Locks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--brand:#62BBC1}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#f7f7f8;color:#0b0b0c}
    .wrap{max-width:900px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;background:#fffdd;border-bottom:1px solid #e5e7eb}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px #62bbc133}
    button{background:var(--brand);color:#032b2f;border:none;cursor:pointer}
    button.warn{background:#f59e0b;color:#111827}
    button.danger{background:#ef4444;color:#fff}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 16px}
    .muted{color:#6b7280}
    .ok{color:#047857}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="row">
      <a href="./index.html" class="muted" style="text-decoration:none">⟵ Admin hub</a>
      <h1 style="margin:0;font-size:18px">Locks</h1>
    </div>
  </header>

  <main class="wrap" style="margin-top:16px">
    <section class="card">
      <div class="row">
        <input id="ref" type="text" placeholder="GLB-…" size="30" />
        <button id="check">Check status</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="lock" class="warn">Lock</button>
        <button id="unlock" class="danger">Unlock</button>
      </div>
      <p class="muted" style="margin-top:10px">Uses <code>X-Admin-Key</code> header and POST body <code>{ ref, lock: true|false }</code>.</p>
    </section>

    <section id="jobCard" class="card" style="display:none;margin-top:14px">
      <div><strong>Reference:</strong> <span id="refOut"></span></div>
      <div><strong>Locked:</strong> <span id="lockedOut"></span></div>
      <div><strong>Current stage:</strong> <span id="stageOut"></span></div>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    const KEY = ()=> localStorage.getItem('ADMIN_KEY') || '';

    async function check(ref){
      $('status').textContent = 'Checking…';
      try{
        const r = await fetch('/api/job?ref=' + encodeURIComponent(ref));
        if(!r.ok){ const t = await r.text(); throw new Error(t || r.status); }
        const data = await r.json();
        const job = data.job || {};
        $('jobCard').style.display = '';
        $('refOut').textContent = ref;
        $('lockedOut').textContent = (typeof job.locked==='boolean') ? (job.locked?'Yes':'No') : 'Unknown';
        $('stageOut').textContent = job.current_stage || 'APPLICATION_SUBMITTED';
        $('status').textContent = 'OK';
        $('status').className = 'ok';
      }catch(e){
        $('status').textContent = 'Error';
        $('status').className = 'bad';
        alert('Error: ' + e.message);
      }
    }

    async function postTo(paths, body){
      const key = KEY();
      if(!key){ alert('Admin key missing — save it in Admin hub'); throw new Error('no key'); }
      let lastErr = null;
      for(const p of paths){
        try{
          const r = await fetch(p, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-Admin-Key':key},
            body: JSON.stringify(body)
          });
          if(!r.ok){ const t = await r.text(); throw new Error(t || r.status); }
          return await r.json().catch(()=> ({}));
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('All endpoints failed');
    }

    $('check').onclick = ()=> {
      const ref = $('ref').value.trim();
      if(!ref) return alert('Enter a reference');
      check(ref);
    };

    $('lock').onclick = async ()=>{
      const ref = $('ref').value.trim();
      if(!ref) return alert('Enter a reference');
      try{
        $('status').textContent = 'Locking…';
        await postTo(['/api/job/lock','/api/lock'], { ref, lock:true });
        $('status').textContent = 'Locked ✓'; $('status').className = 'ok';
        check(ref);
      }catch(e){ $('status').textContent = 'Error'; $('status').className = 'bad'; alert('Error: '+e.message); }
    };

    $('unlock').onclick = async ()=>{
      const ref = $('ref').value.trim();
      if(!ref) return alert('Enter a reference');
      try{
        $('status').textContent = 'Unlocking…';
        await postTo(['/api/job/lock','/api/lock'], { ref, lock:false });
        $('status').textContent = 'Unlocked ✓'; $('status').className = 'ok';
        check(ref);
      }catch(e){ $('status').textContent = 'Error'; $('status').className = 'bad'; alert('Error: '+e.message); }
    };

    // Auto-load if ?ref=
    const refFromUrl = new URLSearchParams(location.search).get('ref');
    if(refFromUrl){ $('ref').value = refFromUrl; check(refFromUrl); }
  </script>
</body>
</html>